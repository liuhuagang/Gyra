# UE5_Lyra学习指南_012_泽_02_一些性能优化的宏

本文章仅为小刚-B站课堂-虚幻引擎视频课程Lyra-精讲的演讲手稿.
本套课程链接:[[UE5]虚幻引擎游戏案例Lyra精讲](https://www.bilibili.com/cheese/play/ss112001159)
前置课程链接:[[UE5]虚幻引擎UEC++从基础到进阶](https://www.bilibili.com/cheese/play/ss28043)

文章内容由小刚撰写,采用了以下多种方式:

1.口述转文字
2.AI重构
3.参考引擎源码
4.Lyra工程源码
5.结合社区论坛各位大佬的解析

- [UE5\_Lyra学习指南\_012\_泽\_02\_一些性能优化的宏](#ue5_lyra学习指南_012_泽_02_一些性能优化的宏)
  - [DECLARE\_SCOPE\_CYCLE\_COUNTER](#declare_scope_cycle_counter)
    - [具体功能：](#具体功能)
    - [典型用途：](#典型用途)
    - [查看结果：](#查看结果)
    - [注意事项：](#注意事项)
  - [SCOPE\_LOG\_TIME\_IN\_SECONDS](#scope_log_time_in_seconds)
    - [核心作用](#核心作用)
    - [参数解析](#参数解析)
    - [使用示例](#使用示例)
    - [输出结果示例](#输出结果示例)
    - [与 `DECLARE_SCOPE_CYCLE_COUNTER` 的区别](#与-declare_scope_cycle_counter-的区别)
    - [注意事项](#注意事项-1)
  - [SCOPED\_BOOT\_TIMING](#scoped_boot_timing)
    - [核心功能](#核心功能)
    - [参数解析](#参数解析-1)
    - [使用示例](#使用示例-1)
    - [如何查看统计结果？](#如何查看统计结果)
    - [与 `DECLARE_SCOPE_CYCLE_COUNTER` 和 `SCOPE_LOG_TIME_IN_SECONDS` 的区别](#与-declare_scope_cycle_counter-和-scope_log_time_in_seconds-的区别)
  - [适用场景](#适用场景)
  - [注意事项](#注意事项-2)
  - [总结](#总结)



## DECLARE_SCOPE_CYCLE_COUNTER
在UE5中	DECLARE_SCOPE_CYCLE_COUNTER(TEXT("Loading GameData Object"), STAT_GameData, STATGROUP_LoadTime);这个宏是做什么用的

在UE5中，`DECLARE_SCOPE_CYCLE_COUNTER` 是一个性能统计宏，用于测量代码块的执行时间。它的作用是在宏所在的代码作用域（即大括号 `{}` 范围内）内自动记录开始和结束时间，计算耗时，并将结果汇总到Unreal Engine的性能统计系统中。

### 具体功能：
1. **测量代码执行时间**  
   它会记录从宏出现的位置到当前作用域结束的时间（例如函数结束或手动的大括号闭合处）。

2. **统计分类与显示**  
   - `TEXT("Loading GameData Object")`：在UE的统计工具（如Unreal Insights或Stat命令）中显示的计时器名称。
   - `STAT_GameData`：唯一的统计标识符（需提前声明为`DECLARE_STATS_GROUP`或类似宏）。
   - `STATGROUP_LoadTime`：统计分组名称，用于将相关统计归类（如加载时间、渲染时间等）。

### 典型用途：
```cpp
void LoadGameData() {
    DECLARE_SCOPE_CYCLE_COUNTER(TEXT("Loading GameData Object"), STAT_GameData, STATGROUP_LoadTime);
    // 加载资源的耗时操作...
    // 作用域结束时，自动记录耗时
}
```

### 查看结果：
- 在编辑器中通过控制台命令 `stat LoadTime` 查看该分组的统计。
- 使用 **Unreal Insights** 工具进行更详细的性能分析。

### 注意事项：
- 需要确保 `STATGROUP_LoadTime` 和 `STAT_GameData` 已正确定义（通常在头文件中通过 `DECLARE_STATS_GROUP` 声明）。
- 过度使用可能影响性能（尤其在频繁调用的代码中），建议仅用于调试或优化关键路径。

这是UE开发者优化性能时常用的工具之一。

## SCOPE_LOG_TIME_IN_SECONDS

在 UE5 中，`SCOPE_LOG_TIME_IN_SECONDS` 是一个 **自动计时日志宏**，用于 **测量代码块的执行时间（秒）**，并在作用域结束时 **自动输出日志**，方便开发者快速调试性能问题。  

---

### 核心作用
1. **自动测量代码块耗时（秒）**  
   - 从宏出现的位置开始计时，直到当前作用域（`{}`）结束时停止，并计算总耗时（单位：秒）。  
   - 适用于快速检查函数、资源加载或其他操作的执行时间。

2. **结束时自动打印日志**  
   - 在作用域退出时，自动输出一条日志（如 `LogTemp`），格式示例：  
     ```
     LogTemp:     ... GameData loaded! took 0.045s
     ```

---

### 参数解析
```cpp
SCOPE_LOG_TIME_IN_SECONDS(
    TEXT("    ... GameData loaded!"), // 日志中显示的自定义消息
    nullptr                           // 可选：指定日志类别（默认LogTemp）
);
```
- **`TEXT("...")`**：日志中显示的自定义消息（如提示当前操作的名称）。  
- **`nullptr`**：可选参数，指定日志类别（如 `LogGameData`）。若为 `nullptr`，默认使用 `LogTemp`。

---

### 使用示例
```cpp
void LoadGameData() {
    // 开始计时，作用域结束时自动输出日志
    SCOPE_LOG_TIME_IN_SECONDS(TEXT("    ... GameData loaded!"), nullptr);
    
    // 模拟耗时操作（如加载数据）
    LoadTextures();
    LoadAssets();
    // 退出作用域时，自动输出：LogTemp:     ... GameData loaded! took 0.123s
}
```

---

### 输出结果示例
```
LogTemp:     ... GameData loaded! took 0.123s
```

---

### 与 `DECLARE_SCOPE_CYCLE_COUNTER` 的区别
| 特性                      | `SCOPE_LOG_TIME_IN_SECONDS`              | `DECLARE_SCOPE_CYCLE_COUNTER`          |
|---------------------------|------------------------------------------|----------------------------------------|
| **用途**                  | 快速调试，直接输出日志                   | 集成到UE统计系统（需工具查看）         |
| **输出方式**              | 自动打印日志（控制台/日志文件）          | 需通过 `stat` 命令或Unreal Insights查看 |
| **单位**                  | 秒（s）                                  | 周期（CPU时钟周期，可转换为秒）        |
| **适用场景**              | 临时调试、简单性能检查                   | 正式性能分析、长期监控                 |

---
### 注意事项
1. **轻量级工具**  
   - 适合快速调试，但无法像 `DECLARE_SCOPE_CYCLE_COUNTER` 那样进行深度统计（如分帧分析）。

2. **日志类别控制**  
   - 可通过第二个参数指定自定义日志类别（如 `LogGame`），避免污染 `LogTemp`。

3. **发布版本影响**  
   - 日志输出在开发版本中有效，发布版本中可能被禁用（依赖UE日志配置）。

---

## SCOPED_BOOT_TIMING
在 UE5 中，`SCOPED_BOOT_TIMING` 是一个 **启动过程性能分析宏**，专门用于 **测量游戏或编辑器启动阶段（Bootstrapping）的代码耗时**，并将结果记录到 Unreal Engine 的启动时间分析系统中。  

---

### 核心功能
1. **自动测量启动阶段代码块的执行时间**  
   - 从宏出现的位置开始计时，直到当前作用域（`{}`）结束时自动停止。  
   - 适用于分析游戏启动、模块加载、引擎初始化等耗时操作。

2. **归类到启动时间统计系统**  
   - 结果会记录到 UE 的 **启动时间分析工具** 中（如 `BootTiming` 统计组），可通过控制台或日志查看。

---

### 参数解析
```cpp
SCOPED_BOOT_TIMING("GameModuleInit");  // 只需传入一个字符串，表示当前计时器的名称
```
- **`"GameModuleInit"`**：在启动分析工具中显示的名称，用于标识当前计时代码块。

---

### 使用示例
```cpp
void FMyGameModule::StartupModule()
{
    // 记录模块初始化的耗时
    SCOPED_BOOT_TIMING("FMyGameModule::StartupModule");
    
    // 模拟耗时的启动操作
    LoadDefaultAssets();
    RegisterComponents();
    // 作用域结束时，自动记录时间
}
```

---

### 如何查看统计结果？
**方法 1：控制台命令**
在 UE 编辑器或游戏运行时，输入：
```bash
stat BootTiming      # 显示启动时间统计
stat BootTiming -full # 显示详细启动时间树
```

**方法 2：日志输出**
启动时，UE 会自动记录启动时间数据，可在日志中搜索：
```
LogBootTiming: FMyGameModule::StartupModule took 45.2ms
```

**方法 3：Unreal Insights**
使用 **Unreal Insights** 进行更详细的启动性能分析：
1. 运行游戏时添加 `-trace=BootTiming` 参数。
2. 在 Unreal Insights 中查看启动时序图。

---

### 与 `DECLARE_SCOPE_CYCLE_COUNTER` 和 `SCOPE_LOG_TIME_IN_SECONDS` 的区别
| 特性                     | `SCOPED_BOOT_TIMING`          | `DECLARE_SCOPE_CYCLE_COUNTER` | `SCOPE_LOG_TIME_IN_SECONDS` |
|--------------------------|-------------------------------|-------------------------------|-----------------------------|
| **用途**                | 专门分析 **启动阶段** 耗时    | 通用性能分析（适用于任何代码） | 快速调试，直接输出日志      |
| **统计系统**            | `BootTiming` 专用分组         | 自定义分组（如 `STATGROUP_LoadTime`） | 仅打印日志，不记录统计      |
| **查看方式**            | `stat BootTiming` / Unreal Insights | `stat` 命令 / Unreal Insights | 直接输出到 `LogTemp`        |
| **适用阶段**            | 仅限启动阶段（引擎初始化时）  | 任何运行阶段                  | 任何运行阶段                |

---

## 适用场景
✅ **游戏/编辑器启动优化**  
✅ **模块加载耗时分析**  
✅ **引擎初始化瓶颈定位**  

---

## 注意事项
1. **仅适用于启动阶段**  
   - 如果用在游戏运行时的代码中，可能不会正确记录（因为 `BootTiming` 系统只在启动时激活）。

2. **避免过度使用**  
   - 在关键路径（如 `LoadMap`、`InitEngine`）使用即可，避免统计开销影响启动性能。

3. **需结合其他工具**  
   - 单独使用只能看到时间数据，结合 **Unreal Insights** 可以分析调用关系和依赖。

---

## 总结
- **`SCOPED_BOOT_TIMING` 是专门用于 UE 启动阶段性能分析的工具**，适合优化游戏启动时间。  
- 如果只是临时测速，可以用 `SCOPE_LOG_TIME_IN_SECONDS`；  
- 如果是通用性能分析，用 `DECLARE_SCOPE_CYCLE_COUNTER`。  

它是 UE 启动优化的重要工具之一，能帮助开发者减少玩家等待时间！ 🚀

以上部分内容参考DeepSeek.





